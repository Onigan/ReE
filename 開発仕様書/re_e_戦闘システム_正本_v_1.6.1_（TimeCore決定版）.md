# ReE 戦闘システム 正本 v1.6.1（TimeCore決定版・UI更新）

- **作成日**：2026-01-11（JST）
- **作成者**：ノア（整理・正本化）
- **上書き宣言（Supersede Mark）**
  - 本書 v1.6.1 は v1.6 を **上書き更新**し、`re_e_戦闘システム_正本_v_1.5.md` を引き続き **完全に置換**する。
  - 本書 v1.6.1 は NotebookLLM 整理メモ `戦闘根本原理：TimeCore（時間戦闘核）.txt` を **補強ソース**として取り込みつつ、**矛盾時は v1.5 の「確定事項」を優先**して整合させた“決定版”である。
- **確定ラベル**
  - **[確定]**：本書でα1.0として固定
  - **[補強]**：NotebookLLMメモ由来で、α1.0で採用するもの（本書で確定に昇格）
  - **[保留]**：将来拡張候補（α1.1+）

---

## 目次
0. 不変原則  
1. 戦闘UI（配置とRoot 5枠固定）  
2. TimeCore（時間戦闘核）  
3. 行動モデル（Schedule → Execute）  
4. ステータス体系（情報二層）  
5. 距離・空間・移動  
6. 攻撃処理（近接／遠距離）  
7. 防御仕様（最重要・確定）  
8. 疲労（Fatigue）  
9. 部位・ゾーン  
10. 状態異常（採用セット）  
11. 魔法・詠唱  
12. 戦闘ログ（二層構造）  
13. AIとナラティブ運用  
14. 禁止事項（事故防止）  
15. テストチェックリスト（α1.0）  
16. 更新履歴  

---

## 0. 不変原則（Hardcore + 時間距離）

- **[確定]** ReEの戦闘は「**時間（Time）**」と「**距離（Distance）**」で成立する。
- **[確定]** ターン制ではなく **TimeCore（μt管理）** によって順序決定される。
- **[確定]** 数値は内部で保持するが、プレイヤーUIには **極力出さない**（HP/MP/命中率/残り秒などを表示しない）。
- **[確定]** プレイヤーの勝敗は反射神経ではなく **事前選択と状況判断**（ログ読解・研究）で左右される。

---

## 1. 戦闘UI（配置とRoot 5枠固定）

### 1.1 CommonUI 配置（固定）
- **[確定]** 左：ActionBoard（OptionButton_0..4）＝**常に5枠**
- **[確定]** 中央〜上：BattleLog（スクロール）
- **[確定]** 下：FreeInput（自由記述）
- **[確定]** Back（戻る）は **ActionBoard 5枠に置かない**  
  - 戻る操作は **Esc / B（Cancel）** を正式とする  
  - 画面内にBackButtonを置く場合は「ActionBoard外（BackArea）」で、Esc/Bと同一動作にする

### 1.2 Root（5枠固定）
- **[確定]** Rootの5枠は以下で固定する（順序も固定）
  1. 攻撃
  2. 防御
  3. 特殊
  4. アイテム
  5. 戦況

### 1.3 サブ選択肢（5枠固定／不足は予備枠）
> α1.0では「5枠固定」を守る。項目が増える場合は「予備枠」→「ページング/Library検索（保留）」の順で拡張する。  
> **狙い（部位/ゾーン指定）はUIボタン化しない。** 既存の「部位・ゾーン」仕様（熟練・条件・自由記述）で扱う。

#### 攻撃（Attack）
- **[確定]** 通常攻撃（近接／遠距離は武器で自動分岐）
- **[確定]** スキル攻撃
- **[確定]** 魔法（詠唱）
- **[予備]** （空き）
- **[予備]** （空き）

#### 防御（Defense）
- **[確定]** ガード
- **[確定]** 防御スキル（鉄壁やパリー　カバーなど）
- **[確定]** 防御魔法（バリアやシールド、反射など）
- **[補強]** 支援／回復 ※「防御カテゴリに置くUI枠」として採用（実効果は魔法/スキル定義側）
- **[予備]** （空き）

#### 特殊（Special）
- **[確定]** 間合い（距離調整：詰める／取る）
- **[補強]** 観察（数値なしの“挙動タグ”提示：例「息が荒い」「足がもつれる」）
- **[補強→確定]** 状況行動（状況により出現）  
  例：交渉／挑発／援護／指示／**休息（呼吸を整える）**／**即席調合（Quick Mix）**
- **[確定]** 環境利用（崩落・遮蔽・高所など）
- **[補強]** 撤退（扱いは戦闘裁定側に従う）

#### アイテム（Item）
- **[確定]** 使用
- **[確定]** 装備切替
- **[補強→確定]** お気に入り（QuickUse）
- **[補強→確定]** 投擲／設置（煙玉・オイル・撒菱・簡易罠など）
- **[補強→確定]** 弾薬（Ammunition）

##### 弾薬（Ammunition）サブメニュー（5枠固定）
- **[確定]** 装填／補給
- **[確定]** 弾切替（弾種変更）
- **[補強]** 弾調整（状態変更：貫通/散弾/信管など。将来拡張）
- **[保留]** 弾調合（α1.0は封印 or 高コスト。乱用防止）
- **[予備]** （空き）

#### 戦況（Situation）
- **[確定]** 提案1（安全な選択肢５個）
- **[確定]** 提案2（平均的な選択肢５個）
- **[確定]** 提案3（リスクの高い効果のある選択肢）
- **[確定]** 提案4（補助や防御より　味方に対する行動など５個）
- **[補強]** 提案5（ランダム）  
  ※UI上の“提案枠”として採用。提案内容はNoa裁定。すべてAPIやLLMを使用してAIが提案する

---

## 2. TimeCore（時間戦闘核）

### 2.1 時間単位
- **[確定]** 内部基本単位：**μt（マイクロティック）**
- **[補強]** 1 tick = 8 μt（推奨）  
  - プレイヤーにとっての体感は「秒」だが、内部はμtで精密に順序決定する

### 2.2 イベント駆動（Schedule → Execute）
- **[確定]** 行動はすべて「予約（Schedule）」され、予定時刻に「成立判定（Execute/Resolve）」が行われる。
- **[補強]** 先に成立した行動が、後続の予約行動に影響しうる（Delay / Fail / Cancel / Convert）。
- **[補強]** 完全同時刻（同μt）に命中判定が重なった場合、双方命中（相討ち）を許容する。

---

## 3. 行動モデル（Schedule → Execute）

### 3.1 行動フェーズ（Action Phases）
- **[確定]** Start → Resolve → Recover
- **[補強]** さらに詳細化する場合、以下を採用してよい（α1.0で有効）
  - Start（準備）
  - Move（移動：射程外なら自動接敵が発生しうる）
  - Resolve（命中・ダメージ等が確定する瞬間）
  - Recover（硬直）
  - Cooldown（再使用CD：行動固有）
  - Global Lock（入力硬直：システム共通の「間」）

### 3.2 主要データ（主要カラム例）
> 実装・データ化のための最小セット（名称はUnity実装で合わせる）

- **ActionIntent（予約データ）**
  - actorId
  - actionType（attack/defense/special/item）
  - executionModel（instant / chant / projectile など）
  - scheduleTime（μt）
  - snapshotPolicy（resolve時参照／発射時固定など）
  - targetPolicy（single/aoe/none）
  - tags（weaponType, element, stance, etc）
  - cost（fatigue等の内部コスト）
- **ActionResult（解決結果）**
  - resolvedTime（μt）
  - outcome（success/fail/partial）
  - effects（damage/status/knockback/timeShift 等のリスト）
  - logTokens（表示用の断片）

---

## 4. ステータス体系（情報二層）

### 4.1 Hardcore原則（UI非表示）
- **[確定]** HP/MP/命中率/残り時間などの“数値”はプレイヤーに見せない。
- **[補強]** 代わりに「観測文（描写）」や「挙動タグ」で提示する（観察・職業・熟練で精度が上がる）。

### 4.2 基礎能力値（Attributes）［補強→確定］
- 物理：STR / DEX / AGI / VIT
- 精神：INT / WIL / PER / CHA / LUK
- 拡張：SOUL / MEM  
  ※SOUL/MEMは世界観コア要素として保持する（α1.0でも内部保持可）

### 4.3 リソース（Resources）［補強→確定］
- HP / MP / ST（スタミナ） / Focus（集中） / Soul（魂力）

### 4.4 耐性（Resistances）［補強→確定］
- 物理：斬／打／突
- 属性：始原七翼（火・水・風・土・光・闇・（第七翼））
- 状態異常：毒／沈黙／恐怖…など

### 4.5 EraTier（時代格）［補強→確定］
- 呪術 ＞ 戦争 ＞ 古代 ＞ 始原  
  高位の時代格は下位の防御を貫通・無効化しうる（例外裁定用）

---

## 5. 距離・空間・移動

### 5.1 空間表現
- **[確定]** XYZセル管理
- **[確定]** 距離単位：0.1m または 0.5m（内部整数）
- **[補強]** 高低差を含めた3D直線距離を採用（ZLevel段階でも可）

### 5.2 近接・射程
- **[確定]** 近接：1.0m以内
- **[確定]** 射程：武器／魔法定義に依存

### 5.3 移動
- **[確定]** 移動はTimeCoreの一部として扱う（移動も行動であり時間を消費）
- **[補強]** 自動接敵（オートクローズ）：射程外で攻撃予約した場合、Moveフェーズで距離を詰めうる  
  ※「移動専念（速い）」と「攻撃接近（遅い）」で係数を分ける

---

## 6. 攻撃処理（近接／遠距離）

### 6.1 近接攻撃
- **[確定]** Start完了時点で近接範囲内ならResolveへ
- **[確定]** Resolve時点の距離で判定

### 6.2 遠距離攻撃
- **[確定]** 発射 → 飛翔 → 命中判定
- **[確定]** 対象が移動した場合は偏差判定

### 6.3 偏差射撃
- **[確定]** 熟練・DEX・HITにより自動判定（差分は内部処理）

---

## 7. 防御仕様（最重要・確定）

### 7.1 防御の原則
- **[確定] 防御は割り込み不可**
- **[確定] 必ず自分のターンで選択**する
- **[確定] 防御は「次の1回の被弾」にのみ有効**
- **[補強→確定]** 受け身／衝撃緩和などの「被弾後リアクション」は、**入力行動ではなく自動判定（受動スキル）**として扱う（Resolving中入力禁止・割り込み禁止を壊さない）

### 7.2 ガード
- **[確定]** 被ダメージ軽減
- **[確定]** 成功度：Fail / Success / Just  
  - Justは確率判定（AGI・スキル・状況）

### 7.3 回避
- **[確定]** 命中判定を回避（AVD・AGI vs HIT・DEX）
- **[確定]** 移動を伴うため疲労が蓄積しやすい

### 7.4 パリィ
- **[確定]** 近接限定・条件付き
- **[確定]** 主効果：TimeShift（行動順有利）

---

## 8. 疲労（Fatigue）

- **[確定]** 回避・移動・重行動で蓄積
- **[確定]** 疲労が高いほど
  - 行動Startが遅れる
  - 回避成功率低下
- **[確定]** 疲労はTimeShiftとして表現

---

## 9. 部位・ゾーン

### 9.1 部位
- **[確定]** 頭部／胴体／腕／脚など
- **[確定]** 狙い指定は条件・熟練・自由記述

### 9.2 ゾーン影響
- **[確定]** 無防備・露出状態で部位異常発生率上昇

---

## 10. 状態異常（採用セット）

> v1.5の「…」を、NotebookLLMメモで補強し **α1.0採用セットとして確定**する。  
> 表示は数値ではなく観測文で行う。

- **[確定]** 出血（Bleed）
- **[確定]** 毒（Poison）
- **[確定]** 火傷（Burn）
- **[確定]** 凍結（Freeze）
- **[確定]** 感電（Shock）
- **[確定]** 恐怖（Fear）
- **[確定]** 沈黙（Silence）※自由記述入力が封印される（Hardcore演出）
- **[確定]** 眩暈／よろめき（Stun系：短時間のTimeShift/入力阻害として表現）

---

## 11. 魔法・詠唱

- **[確定]** 魔法は「詩（言葉）・構文（ルール）・魂（意志）」で成立する
- **[補強→確定]** 調合（錬金・クラフト）は **戦闘外（拠点／工房／キャンプ）** が本体。戦闘中は例外として **即席調合（Quick Mix）** のみ（条件付き・高コスト・失敗/暴発あり）
- **[補強→確定]** 三層構造
  - 詩唱魔法（道具不要・即時）
  - 陣詠魔法（魔法陣必要・中範囲）
  - 詩構術式（素材・長時間・世界干渉）
- **[補強→確定]** 発現形式（Delivery）
  - 発現／飛翔（Projectile）／放射（Ray）／範囲（AoE）／フィールド／付与／召喚／変質／設置／連鎖
- **[補強→確定]** スナップショット
  - 射撃（ロック位置型）は「放った瞬間に狙点が固定」
- **[補強→確定]** 詠唱中断
  - 高位魔法ほど詠唱が長く、被弾で中断や暴走のリスク

---

## 12. 戦闘ログ（二層構造）

- **[補強→確定]** ログには二層がある
  1) **Noaの記録（正史）**：数値計算に基づいた正確な断片記録（ただし数値は伏せる）  
  2) **NPCの語り（伝承）**：誤解や誇張を含む不確かな物語（世界へ拡散する）
- **[補強→確定]** 研究ノート：プレイヤーが手書きで記録し、転生や世代を超えて攻略精度を上げる  
  ※システムは“自動攻略メモ”を作らない。ログ引用などの作業軽減のみ許可。

---

## 13. AIとナラティブ運用

- **[補強→確定]** 観測解像度：職業・熟練により提示情報が具体化する（例：医療、ハンター、鑑定）
- **[補強→確定]** 敵AI：最適解固定ではなく、疲労・状態・距離に応じた判断の揺らぎを持つ
- **[確定]** 「語り→顕現」原則により、戦闘中の状況提示はログと観測文が主役

---

## 14. 禁止事項（事故防止）

- **[確定]** BackをRoot 5枠に置かない
- **[確定]** HP/MP/命中率/残り秒などの“数値UI表示”をしない
- **[確定]** Resolving中に新しい行動入力を許可しない（防御も例外なし）
- **[確定]** 「割り込み防御」は存在しない（今後も採用しない）

## 1.4 UIツリー（厳密仕様：ボタン名・無効条件・戻り規則）【凍結】

### 1.4.1 用語定義（UI状態）
- **Root**：左5枠が「攻撃/防御/特殊/アイテム/戦況」を表示する最上位
- **SubMenu**：Rootの配下（例：攻撃→通常攻撃/スキル/魔法…）
- **TargetSelect**：対象選択（例：Enemy / Self / Ally / Field 等）
- **LibrarySelect**：一覧（魔法・スキル・アイテムの候補をリストで選ぶ画面。α1.0では“入口のみ用意”し中身は段階実装可）
- **Resolving**：ログ進行中（左5枠は空。入力不可）
- **Overlay（History）**：ログ履歴オーバーレイ。IsHistoryOpen=true の状態

> 注意：Confirm（実行）ステートは **使用禁止**（定義は残っても遷移禁止）

---

### 1.4.2 Root（5枠固定・表示名固定）
Rootの左5枠は常に以下。順序変更・表記変更禁止。
1. **攻撃**
2. **防御**
3. **特殊**
4. **アイテム**
5. **戦況**

---

### 1.4.3 SubMenu（表示名固定）
#### 攻撃（Attack SubMenu）
1. **通常攻撃**
2. **スキル攻撃**
3. **魔法（詠唱）**
4. **（予備）**
5. **（予備）**

#### 防御（Defense SubMenu）
1. **ガード**
2. **防御スキル**
3. **防御魔法**
4. **支援／回復**
5. **（予備）**

#### 特殊（Special SubMenu）
1. **間合い**
2. **観察**
3. **状況行動**
4. **環境利用**
5. **撤退**

#### アイテム（Item SubMenu）
1. **使用**
2. **装備切替**
3. **お気に入り**
4. **投擲／設置**
5. **弾薬**

#### 弾薬（Ammunition SubMenu）
1. **装填／補給**
2. **弾切替**
3. **弾調整**
4. **弾調合（保留）**
5. **（予備）**

#### 戦況（Situation SubMenu）
1. **提案1**
2. **提案2**
3. **提案3**
4. **提案4**
5. **提案5**

---

### 1.4.4 TargetSelect（対象ラベルの標準）
α1.0のTargetSelectは、最低限として以下のラベルを標準採用する（必要に応じて“無効化表示”は許可、削除は不可）。
- **Enemy**
- **Self**
- **Ally**
- **Field**
- **Back**（※ボタンとしては置かない。Cancelで戻るのが正。ただしUI実装都合で置く場合はAction枠ではなく別UI）

> “敵/味方の個別名（Enemy_0等）”は TargetSelect の詳細ページ（またはLibrary）側で扱う。  
> 最初は Enemy のみでも良いが、ボタン枠は将来拡張できるよう残す。

---

### 1.4.5 Commit（確定）規則：Confirm禁止・最終選択=即Commit
- **Confirm（実行）ボタン／画面は一切出さない**
- **最終選択地点で即CommitしてResolvingへ**
  - 例：
    - 攻撃→通常攻撃→TargetSelect（Enemy）→ **即Commit→Resolving**
    - 防御→ガード→ **即Commit→Resolving**
    - アイテム→投擲／設置→TargetSelect（Field/Enemy等）→ **即Commit→Resolving**
- 未実装項目は **Commitしない**（次節のスタブ規約に従う）

---

### 1.4.6 無効条件（Disable Rules：表示は残し、押せない）
**「枠は残す／表示は残す／押せない」**を原則とする（5枠UIを崩さない）。

#### 共通無効条件
- **Resolving中**：左5枠は **全て空**（ラベルなし、押せない）
- **Overlay（IsHistoryOpen=true）中**：
  - 自動送り停止
  - 背景クリック加速停止
  - Failsafe停止
  - （UIボタン自体は押せても良いが、戦闘進行には影響させない）

#### アイテム無効条件（例）
- **弾薬**：遠距離武器を所持していない／弾薬概念が無い場合は **無効化**
- **装填／弾切替**：弾が存在しない場合は **無効化**
- **投擲／設置**：投擲物がない場合は **無効化**
- **お気に入り**：登録0件なら **無効化**

#### 特殊の無効条件（例）
- **撤退**：撤退不可の戦闘では **無効化**
- **状況行動**：状況が無い場合は押せても「状況なし」ログ（1行）を出してRootへ戻す（Commitしない）

> 無効化の見せ方：ボタンは表示するがInteractable=false等で押せない（または押したら“不可”ログ1行で戻す）。  
> どちらを採るかは項目ごとに固定してよいが、**勝手に消さない**。

---

### 1.4.7 戻り規則（Back / Cancel：事故防止）
- **Cancel（Esc/B）**は「一段戻る」のみ（スタックを持つ）
- 遷移の基本：
  - TargetSelect → SubMenuへ戻る
  - SubMenu → Rootへ戻る
  - Root → 何もしない（またはポーズUI。α1.0では“何もしない”推奨）
- **Resolving中のCancelは無効**（進行中に戻らせない）
- **Overlay中のCancel**はOverlayを閉じる（優先）

---

### 1.4.8 Resolving中の進行（Unit-A凍結ルール）
- 放置：ログが**1行ずつ**自動で流れる
- 背景クリック：待ちをスキップし **1クリック=1行**
- クリックは「背景のみ」：
  - UI上をクリックしても進まない（EventSystem pointer over UI）
  - Overlay中はクリックで進まない
- delay<=0 の連鎖は **必ず1フレーム挟んで**フリーズ防止
- Failsafe：Overlayが閉じている状態で進行が止まった場合、**10秒でRootへ復帰**

---

### 1.4.9 未実装スタブ規約（α1.0の作業順を守るため）
UIツリーを先に完成させるため、未実装項目は必ず次の挙動にする。

- 未実装ボタンを押す
  - 表ログに **1行だけ**出す：`未実装：<選択パス>`（例：未実装：攻撃→スキル攻撃）
  - **即Rootへ戻る**
  - **Commitしない／Resolvingに入らない**
- “無効化”と“未実装”は区別してよいが、どちらも **迷子にしない**こと

---

### 1.4.10 受入条件（UIツリー凍結チェック）
- Rootの5枠が常に固定順で出る
- Confirm（実行）／敵ターン開始ボタンが一切出ない
- Resolving中は左5枠が空で押せない
- Cancelで一段戻れる（迷子にならない）
- 未実装ボタンは1行ログ→Rootへ戻る（Commitしない）




---

## 15. テストチェックリスト（α1.0）

1. Rootが常に5枠で崩れない（攻撃/防御/特殊/アイテム/戦況）
2. BackがActionBoardに紛れない（Esc/Bで戻れる）
3. Commit後に入力ロックが入る（Root/サブが押せない）
4. Resolving中はログ主導で進行する（背景クリックで次ログ／AutoAdvanceで放置進行）
5. Resolving中に防御が押せない（割り込み不可）
6. 近接：Resolve時点距離で当たる／遠距離：飛翔＋偏差
7. 回避・移動で疲労が増え、TimeShiftが乗る
8. 状態異常（毒/恐怖/沈黙等）が観測文として出る（数値は出ない）
9. LogHistoryOverlay中は進行が止まる
10. FreeInputはIME変換中に送信されない

---

## 16. 更新履歴
- 2026-01-11 / ノア / v1.6.1：UI更新（アイテムに投擲/設置を追加、弾薬サブメニューへ装填/弾切替を統合、攻撃側AmmoSwapを撤去、特殊の状況行動に休息/即席調合を追加、受け身を自動判定に整理、調合は戦闘外本体＋戦闘中は即席のみ）
- 2026-01-10 / ノア / v1.6 作成：v1.5を正として矛盾解消、NotebookLLM整理メモを補強採用（状態異常・二層ログ・QuickUse/AmmoSwap等）
